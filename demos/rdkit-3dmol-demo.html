<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CREB Enhanced Molecular Visualization - Official RDKit.js</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .status {
            padding: 15px 20px;
            font-size: 14px;
            font-weight: 500;
            border-left: 4px solid #007bff;
            margin: 0;
            background: #f8f9fa;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }
        .control-group label {
            font-weight: 600;
            color: #495057;
            min-width: 100px;
        }
        .control-group input, .control-group select, .control-group button {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-group button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-group button:hover:not(:disabled) {
            background: #0056b3;
        }
        .control-group button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .visualization-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .viewer {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
            background: white;
        }
        .viewer-header {
            background: #e9ecef;
            padding: 10px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .version-info {
            font-size: 12px;
            font-weight: normal;
            opacity: 0.7;
        }
        .viewer-content {
            height: 400px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        #rdkit-viewer {
            width: 100%;
            height: 100%;
            text-align: center;
            overflow: hidden;
        }
        #mol3d-viewer {
            width: 100%;
            height: 100%;
        }
        .properties {
            grid-column: span 2;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 0 20px 20px 20px;
        }
        .properties h3 {
            margin-top: 0;
            color: #495057;
        }
        .properties-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .property {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .property-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        .property-value {
            font-size: 1.2em;
            color: #28a745;
            word-break: break-all;
        }
        .loading, .error, .info {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
        .loading {
            color: #6c757d;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border-radius: 4px;
        }
        .info {
            color: #0c5460;
            background: #d1ecf1;
            border-radius: 4px;
        }
        .debug-info {
            padding: 15px 20px;
            background: #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #495057;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CREB Enhanced Molecular Visualization</h1>
            <p>RDKit.js, 3Dmol.js, and PubChem Integration</p>
        </div>

        <div class="status" id="status">Initializing RDKit.js WASM module...</div>

        <div class="controls">
            <div class="control-group">
                <label for="pubchem-search">PubChem Search:</label>
                <input type="text" id="pubchem-search" placeholder="Enter compound name or CID (e.g., caffeine, aspirin, 2244)">
                <button onclick="searchPubChem()" id="search-btn" disabled>Search</button>
                <button onclick="loadPubChemExample()" id="pubchem-example-btn" disabled>Random Drug</button>
            </div>
            <div class="control-group">
                <label for="molecule-input">SMILES:</label>
                <input type="text" id="molecule-input" value="O" placeholder="Enter SMILES string">
                <button onclick="loadMolecule()" id="load-btn" disabled>Load Molecule</button>
                <button onclick="loadExample()" id="example-btn" disabled>Random Example</button>
            </div>
            <div class="control-group">
                <label for="style-select">3D Style:</label>
                <select id="style-select" onchange="update3DStyle()" disabled>
                    <option value="stick">Stick</option>
                    <option value="sphere">Sphere</option>
                    <option value="line">Line</option>
                    <option value="cartoon">Cartoon</option>
                </select>
                <button onclick="exportSVG()" id="svg-btn" disabled>Export SVG</button>
                <button onclick="exportPNG()" id="png-btn" disabled>Export PNG</button>
            </div>
        </div>

        <div class="visualization-container">
            <div class="viewer">
                <div class="viewer-header">
                    2D Structure (RDKit.js)
                    <span class="version-info" id="rdkit-version">Loading...</span>
                </div>
                <div class="viewer-content">
                    <div id="rdkit-viewer" class="loading">Waiting for RDKit.js initialization...</div>
                </div>
            </div>
            <div class="viewer">
                <div class="viewer-header">
                    3D Structure (3Dmol.js)
                    <span class="version-info" id="mol3d-version">Loading...</span>
                </div>
                <div class="structure-info" id="structure-info" style="background: #e8f4fd; padding: 8px; margin: 5px; border-radius: 4px; font-size: 12px; display: none;">
                    <strong>Structure Source:</strong> <span id="structure-source">Generated</span>
                </div>
                <div class="viewer-content">
                    <div id="mol3d-viewer" class="loading">Waiting for 3Dmol.js...</div>
                </div>
            </div>
        </div>

        <div class="properties">
            <h3>Molecular Properties</h3>
            <div class="properties-grid">
                <div class="property" id="compound-name-property" style="display: none;">
                    <div class="property-label">Compound Name</div>
                    <div class="property-value" id="compound-name">-</div>
                </div>
                <div class="property" id="pubchem-cid-property" style="display: none;">
                    <div class="property-label">PubChem CID</div>
                    <div class="property-value" id="pubchem-cid">-</div>
                </div>
                <div class="property">
                    <div class="property-label">Molecular Weight</div>
                    <div class="property-value" id="mw-value">-</div>
                </div>
                <div class="property">
                    <div class="property-label">LogP</div>
                    <div class="property-value" id="logp-value">-</div>
                </div>
                <div class="property">
                    <div class="property-label">TPSA</div>
                    <div class="property-value" id="tpsa-value">-</div>
                </div>
                <div class="property">
                    <div class="property-label">H-Bond Donors</div>
                    <div class="property-value" id="hbd-value">-</div>
                </div>
                <div class="property">
                    <div class="property-label">H-Bond Acceptors</div>
                    <div class="property-value" id="hba-value">-</div>
                </div>
                <div class="property">
                    <div class="property-label">Canonical SMILES</div>
                    <div class="property-value" id="canonical-smiles">-</div>
                </div>
            </div>
        </div>

        <div class="debug-info" id="debug-info">
            Debug: Initializing...
        </div>
    </div>

    <!-- Load RDKit.js using the official method -->
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    <!-- Load 3Dmol.js -->
    <script src="https://3dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    
    <script>
        // Global variables
        let RDKit = null;
        let mol3dViewer = null;
        let systemReady = false;

        // Example molecules with more variety
        const examples = [
            'CCO', // Ethanol
            'CC(=O)OC1=CC=CC=C1C(=O)O', // Aspirin
            'CN1C=NC2=C1C(=O)N(C(=O)N2C)C', // Caffeine
            'CC(C)CC1=CC=C(C=C1)C(C)C(=O)O', // Ibuprofen
            'C1=CC=C(C=C1)C2=CC=C(C=C2)C3=CC=CC=C3', // Triphenylbenzene
            'C1=CC=C2C(=C1)C=CC=C2', // Naphthalene
            'C1CCCCC1', // Cyclohexane
            'CC(C)(C)C1=CC=C(C=C1)O', // BHT
            'C1=CC=C(C=C1)N', // Aniline
            'C1=CC=NC=C1' // Pyridine
        ];

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function updateDebug(message) {
            const debugEl = document.getElementById('debug-info');
            debugEl.textContent = 'Debug: ' + message;
        }

        function enableControls() {
            const controls = ['load-btn', 'example-btn', 'search-btn', 'pubchem-example-btn', 'style-select', 'svg-btn', 'png-btn'];
            controls.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = false;
            });
            systemReady = true;
        }

        // Initialize using the official RDKit.js method
        async function initializeRDKit() {
            try {
                updateStatus('Loading RDKit.js WASM module...');
                updateDebug('Calling initRDKitModule()...');

                // Use the official initialization method
                RDKit = await window.initRDKitModule();
                
                updateDebug('RDKit module initialized successfully');
                
                // Check version availability
                let version = 'Unknown';
                try {
                    if (RDKit.version) {
                        version = RDKit.version();
                    }
                } catch (e) {
                    console.warn('Version check failed:', e);
                }
                
                updateStatus('RDKit.js v' + version + ' loaded successfully');
                
                // Update version display
                document.getElementById('rdkit-version').textContent = 'v' + version;
                
                // Test basic functionality
                const testMol = RDKit.get_mol('CCO');
                if (testMol) {
                    updateDebug('RDKit functionality test passed');
                    
                    // Log available methods for debugging
                    console.log('Available RDKit methods:', Object.keys(RDKit));
                    console.log('Available molecule methods:', Object.getOwnPropertyNames(testMol.__proto__));
                    
                    // Test which property methods are available
                    const availableMethods = [];
                    const methodsToTest = [
                        'get_mw', 'mw', 
                        'get_logp', 'logp', 
                        'get_tpsa', 'tpsa', 
                        'get_num_hbd', 'num_hbd', 
                        'get_num_hba', 'num_hba', 
                        'get_smiles', 'smiles', 
                        'get_svg', 'get_svg_with_highlights',
                        'get_descriptors', 'descriptors'
                    ];
                    methodsToTest.forEach(method => {
                        if (typeof testMol[method] === 'function') {
                            availableMethods.push(method);
                        }
                    });
                    console.log('Available property methods:', availableMethods);
                    
                    // Test descriptors if available
                    if (typeof testMol.get_descriptors === 'function') {
                        try {
                            const desc = testMol.get_descriptors();
                            console.log('Sample descriptors:', desc);
                        } catch (e) {
                            console.warn('Descriptors test failed:', e);
                        }
                    }
                    
                    testMol.delete();
                    
                    return true;
                } else {
                    throw new Error('RDKit functionality test failed');
                }
                
            } catch (error) {
                console.error('RDKit initialization error:', error);
                updateStatus('RDKit.js initialization failed: ' + error.message, 'error');
                updateDebug('RDKit initialization error: ' + error.message);
                document.getElementById('rdkit-viewer').innerHTML = 
                    '<div class="error">RDKit.js failed to initialize<br>' + error.message + '</div>';
                return false;
            }
        }

        // Initialize 3Dmol.js
        function initialize3DMol() {
            try {
                updateDebug('Initializing 3Dmol.js...');
                
                if (typeof $3Dmol === 'undefined') {
                    throw new Error('3Dmol.js not loaded');
                }

                const mol3dElement = document.getElementById('mol3d-viewer');
                if (!mol3dElement) {
                    throw new Error('3Dmol viewer element not found');
                }
                
                // Clear any existing content
                mol3dElement.innerHTML = '';
                
                // Create viewer with better configuration
                mol3dViewer = $3Dmol.createViewer(mol3dElement, {
                    backgroundColor: 'white',
                    antialias: true,
                    cartoonQuality: 10
                });

                // Test the viewer by adding a simple test
                try {
                    mol3dViewer.setBackgroundColor('white');
                    mol3dViewer.render();
                } catch (testError) {
                    throw new Error('3Dmol viewer test failed: ' + testError.message);
                }

                updateDebug('3Dmol.js initialized successfully');
                document.getElementById('mol3d-version').textContent = '3Dmol.js Ready';
                
                return true;
                
            } catch (error) {
                console.error('3Dmol initialization error:', error);
                updateDebug('3Dmol initialization error: ' + error.message);
                const mol3dElement = document.getElementById('mol3d-viewer');
                if (mol3dElement) {
                    mol3dElement.innerHTML = 
                        '<div class="error">3Dmol.js failed to initialize<br>' + error.message + '</div>';
                }
                return false;
            }
        }

        // Main initialization
        async function initializeVisualization() {
            try {
                updateDebug('Starting initialization sequence...');

                // Initialize RDKit first (this is the critical one)
                const rdkitSuccess = await initializeRDKit();
                
                // Initialize 3Dmol
                const mol3dSuccess = initialize3DMol();

                if (rdkitSuccess && mol3dSuccess) {
                    updateStatus('All systems ready! Both RDKit.js and 3Dmol.js loaded.', 'success');
                    updateDebug('Both RDKit.js and 3Dmol.js ready');
                    enableControls();
                    
                    // Auto-load default molecule
                    setTimeout(() => {
                        loadMolecule();
                    }, 500);
                    
                } else if (rdkitSuccess) {
                    updateStatus('RDKit.js ready, 3Dmol.js failed. 2D visualization available.', 'warning');
                    updateDebug('RDKit.js ready, 3Dmol.js failed');
                    enableControls();
                    
                    // Auto-load default molecule for 2D only
                    setTimeout(() => {
                        loadMolecule();
                    }, 500);
                    
                } else {
                    updateStatus('Initialization failed. Please refresh the page.', 'error');
                    updateDebug('Both libraries failed to initialize');
                }

            } catch (error) {
                console.error('Initialization failed:', error);
                updateStatus('Critical initialization error: ' + error.message, 'error');
                updateDebug('Critical error: ' + error.message);
            }
        }

        // PubChem 3D Structure Integration
        async function fetchPubChem3DStructure(cid) {
            try {
                updateDebug(`Fetching 3D structure for CID: ${cid}`);
                updateStatus('Fetching real 3D structure from PubChem...', 'progress');
                
                // First try to get 3D SDF structure
                const sdf3DUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/SDF?record_type=3d`;
                const sdf3DResponse = await fetch(sdf3DUrl);
                
                if (sdf3DResponse.ok) {
                    const sdf3DData = await sdf3DResponse.text();
                    updateDebug('Successfully fetched 3D SDF structure from PubChem');
                    updateStatus('Using real 3D structure data from PubChem!', 'success');
                    return { format: 'sdf', data: sdf3DData };
                }
                
                // Fallback to 2D SDF if 3D not available
                updateDebug('3D structure not available, trying 2D structure...');
                const sdf2DUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/SDF`;
                const sdf2DResponse = await fetch(sdf2DUrl);
                
                if (sdf2DResponse.ok) {
                    const sdf2DData = await sdf2DResponse.text();
                    updateDebug('Successfully fetched 2D SDF structure (will be used for 3D visualization)');
                    updateStatus('Using 2D structure from PubChem (3D not available)', 'warning');
                    return { format: 'sdf', data: sdf2DData };
                }
                
                throw new Error('No SDF structure data available');
                
            } catch (error) {
                console.error('Failed to fetch PubChem structure:', error);
                updateDebug('PubChem structure fetch failed: ' + error.message);
                updateStatus('PubChem structure unavailable, using generated structure', 'warning');
                return null;
            }
        }

        async function fetchPubChemConformers(cid) {
            try {
                updateDebug(`Fetching conformer data for CID: ${cid}`);
                
                const conformerUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/conformers/JSON?conformers_type=3d`;
                const conformerResponse = await fetch(conformerUrl);
                
                if (conformerResponse.ok) {
                    const conformerData = await conformerResponse.json();
                    updateDebug('Successfully fetched conformer data');
                    return conformerData;
                } else {
                    updateDebug('Conformer data not available');
                    return null;
                }
                
            } catch (error) {
                console.error('Failed to fetch conformers:', error);
                updateDebug('Conformer fetch failed: ' + error.message);
                return null;
            }
        }

        // PubChem search functionality
        async function searchPubChem() {
            const searchTerm = document.getElementById('pubchem-search').value.trim();
            if (!searchTerm) {
                updateStatus('Please enter a compound name or CID', 'error');
                return;
            }

            try {
                updateStatus('Searching PubChem for: ' + searchTerm);
                updateDebug('PubChem search initiated: ' + searchTerm);

                // Show loading state
                document.getElementById('rdkit-viewer').innerHTML = '<div class="loading">Searching PubChem...</div>';
                if (mol3dViewer) {
                    mol3dViewer.clear();
                    document.getElementById('mol3d-viewer').innerHTML = '<div class="loading">Searching PubChem...</div>';
                }

                // Search PubChem for compound
                let cid;
                if (/^\d+$/.test(searchTerm)) {
                    // If it's a number, assume it's a CID
                    cid = searchTerm;
                } else {
                    // Search by name
                    const searchUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(searchTerm)}/cids/JSON`;
                    const searchResponse = await fetch(searchUrl);
                    
                    if (!searchResponse.ok) {
                        throw new Error(`PubChem search failed: ${searchResponse.status}`);
                    }
                    
                    const searchData = await searchResponse.json();
                    if (!searchData.IdentifierList || !searchData.IdentifierList.CID || searchData.IdentifierList.CID.length === 0) {
                        throw new Error('No compounds found for: ' + searchTerm);
                    }
                    
                    cid = searchData.IdentifierList.CID[0]; // Use first result
                }

                updateDebug(`Found PubChem CID: ${cid}`);

                // Get SMILES from PubChem
                const smilesUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/CanonicalSMILES/JSON`;
                const smilesResponse = await fetch(smilesUrl);
                
                if (!smilesResponse.ok) {
                    throw new Error(`Failed to get SMILES: ${smilesResponse.status}`);
                }
                
                const smilesData = await smilesResponse.json();
                if (!smilesData.PropertyTable || !smilesData.PropertyTable.Properties || smilesData.PropertyTable.Properties.length === 0) {
                    throw new Error('No SMILES data found for CID: ' + cid);
                }
                
                const smiles = smilesData.PropertyTable.Properties[0].CanonicalSMILES;
                updateDebug(`Retrieved SMILES: ${smiles}`);

                // Validate SMILES before proceeding
                if (!smiles || typeof smiles !== 'string' || smiles.trim() === '') {
                    throw new Error('Invalid SMILES data received from PubChem');
                }

                // Update the SMILES input field
                document.getElementById('molecule-input').value = smiles;

                // Load the molecule with enhanced 3D structure data
                await loadMoleculeFromSMILES(smiles, { 
                    pubchemCID: cid, 
                    searchTerm: searchTerm,
                    use3DStructure: true  // Enable 3D structure fetching
                });

                updateStatus(`PubChem compound loaded: ${searchTerm} (CID: ${cid})`, 'success');

            } catch (error) {
                console.error('PubChem search failed:', error);
                updateStatus('PubChem search failed: ' + error.message, 'error');
                updateDebug('PubChem search error: ' + error.message);
                
                // Reset viewers to show error
                document.getElementById('rdkit-viewer').innerHTML = '<div class="error">PubChem search failed<br>' + error.message + '</div>';
                if (mol3dViewer) {
                    mol3dViewer.clear();
                    document.getElementById('mol3d-viewer').innerHTML = '<div class="error">PubChem search failed</div>';
                }
            }
        }

        async function loadMoleculeFromSMILES(smiles, metadata = {}) {
            if (!systemReady || !RDKit) {
                updateStatus('System not ready yet', 'error');
                return;
            }

            // Validate SMILES input
            if (!smiles || typeof smiles !== 'string' || smiles.trim() === '') {
                updateStatus('Invalid SMILES string provided', 'error');
                return;
            }

            smiles = smiles.trim();

            try {
                updateDebug('Processing SMILES: ' + smiles);
                if (metadata.cid) {
                    updateDebug('PubChem CID available: ' + metadata.cid);
                }

                // Show loading states
                document.getElementById('rdkit-viewer').innerHTML = '<div class="loading">Generating 2D structure...</div>';
                if (mol3dViewer) {
                    mol3dViewer.clear();
                    document.getElementById('mol3d-viewer').innerHTML = '<div class="loading">Generating 3D structure...</div>';
                }

                // Render 2D structure
                await render2D(smiles);

                // Render 3D structure (with PubChem CID if available)
                if (mol3dViewer) {
                    await render3D(smiles, metadata.cid);
                }

                // Calculate properties (include PubChem metadata if available)
                await updateProperties(smiles, metadata);

                updateDebug('Molecule processing completed');

            } catch (error) {
                console.error('Failed to load molecule:', error);
                updateStatus('Failed to load molecule: ' + error.message, 'error');
                updateDebug('Molecule loading error: ' + error.message);
            }
        }

        async function loadMolecule() {
            if (!systemReady || !RDKit) {
                updateStatus('System not ready yet', 'error');
                return;
            }

            const smiles = document.getElementById('molecule-input').value.trim();
            if (!smiles) {
                updateStatus('Please enter a SMILES string', 'error');
                return;
            }

            try {
                updateStatus('Loading molecule: ' + smiles);
                await loadMoleculeFromSMILES(smiles);
                updateStatus('Molecule loaded successfully: ' + smiles, 'success');

            } catch (error) {
                console.error('Failed to load molecule:', error);
                updateStatus('Failed to load molecule: ' + error.message, 'error');
                updateDebug('Molecule loading error: ' + error.message);
            }
        }

        async function render2D(smiles) {
            try {
                updateDebug('Rendering 2D structure...');
                
                // Validate SMILES input
                if (!smiles || typeof smiles !== 'string' || smiles.trim() === '') {
                    throw new Error('Invalid SMILES string for 2D rendering');
                }
                
                smiles = smiles.trim();
                
                const mol = RDKit.get_mol(smiles);
                if (!mol) {
                    throw new Error('Invalid SMILES: ' + smiles);
                }

                // Generate SVG with better error handling
                let svg;
                try {
                    // Try the simplest SVG generation first
                    if (typeof mol.get_svg === 'function') {
                        svg = mol.get_svg();
                        updateDebug('SVG generated using get_svg()');
                    } else if (typeof mol.get_svg_with_highlights === 'function') {
                        svg = mol.get_svg_with_highlights('{}');
                        updateDebug('SVG generated using get_svg_with_highlights()');
                    } else {
                        throw new Error('No SVG generation method available');
                    }
                } catch (svgError) {
                    console.warn('Primary SVG generation failed:', svgError);
                    try {
                        // Try alternative SVG generation
                        if (typeof mol.get_svg_with_highlights === 'function') {
                            svg = mol.get_svg_with_highlights('{}');
                            updateDebug('SVG generated using fallback get_svg_with_highlights()');
                        } else if (typeof mol.get_svg === 'function') {
                            svg = mol.get_svg();
                            updateDebug('SVG generated using fallback get_svg()');
                        } else {
                            throw new Error('All SVG generation methods failed');
                        }
                    } catch (fallbackError) {
                        console.warn('Fallback SVG generation failed:', fallbackError);
                        // Final fallback to simple text representation
                        svg = `<div class="info">2D structure loaded<br>SMILES: ${smiles}<br><small>SVG rendering not available</small></div>`;
                    }
                }

                document.getElementById('rdkit-viewer').innerHTML = svg;
                mol.delete();
                
                updateDebug('2D structure rendered successfully');
                
            } catch (error) {
                console.error('2D rendering error:', error);
                updateDebug('2D rendering error: ' + error.message);
                document.getElementById('rdkit-viewer').innerHTML = 
                    '<div class="error">2D rendering failed:<br>' + error.message + '</div>';
            }
        }

        async function render3D(smiles, cid = null) {
            try {
                if (!mol3dViewer) {
                    throw new Error('3Dmol viewer not available');
                }

                updateDebug('Rendering 3D structure...');

                // Clear previous content and recreate viewer container
                const mol3dElement = document.getElementById('mol3d-viewer');
                mol3dElement.innerHTML = '';
                
                // Recreate the 3Dmol viewer
                mol3dViewer = $3Dmol.createViewer(mol3dElement, {
                    backgroundColor: 'white',
                    antialias: true,
                    cartoonQuality: 10
                });
                
                let structureData = null;
                
                // Try to get PubChem 3D structure if CID is available
                if (cid) {
                    updateDebug(`Attempting to fetch PubChem 3D structure for CID: ${cid}`);
                    structureData = await fetchPubChem3DStructure(cid);
                }
                
                // Use PubChem structure if available
                if (structureData) {
                    updateDebug(`Using PubChem ${structureData.format} structure data`);
                    mol3dViewer.addModel(structureData.data, structureData.format);
                    
                    // Update UI to show source
                    document.getElementById('structure-info').style.display = 'block';
                    document.getElementById('structure-source').textContent = `PubChem 3D SDF (CID: ${cid})`;
                } else {
                    // Fallback to generated PDB data
                    updateDebug('Falling back to generated PDB structure');
                    const pdbData = createPDBFromSMILES(smiles);
                    
                    if (!pdbData) {
                        throw new Error('Failed to generate PDB data');
                    }
                    
                    mol3dViewer.addModel(pdbData, 'pdb');
                    
                    // Update UI to show source
                    document.getElementById('structure-info').style.display = 'block';
                    document.getElementById('structure-source').textContent = 'Generated from SMILES';
                }
                
                // Apply default style
                const currentStyle = document.getElementById('style-select').value;
                applyStyle(currentStyle);
                
                // Center and render
                mol3dViewer.zoomTo();
                mol3dViewer.render();
                
                updateDebug('3D structure rendered successfully');
                
            } catch (error) {
                console.error('3D rendering error:', error);
                updateDebug('3D rendering error: ' + error.message);
                
                // Show error in the viewer
                const mol3dElement = document.getElementById('mol3d-viewer');
                if (mol3dElement) {
                    mol3dElement.innerHTML = 
                        '<div class="error">3D rendering failed:<br>' + error.message + '<br><small>Try a different molecule or refresh the page</small></div>';
                }
            }
        }

        function createPDBFromSMILES(smiles) {
            // Enhanced PDB structures with proper formatting and more molecules
            const structures = {
                'CCO': `HEADER    ETHANOL                         
ATOM      1  C   ETH A   1       0.000   0.000   0.000  1.00 20.00           C  
ATOM      2  C   ETH A   1       1.530   0.000   0.000  1.00 20.00           C  
ATOM      3  O   ETH A   1       2.040   1.330   0.000  1.00 20.00           O  
ATOM      4  H   ETH A   1      -0.340  -0.510  -0.880  1.00 20.00           H  
ATOM      5  H   ETH A   1      -0.340  -0.510   0.880  1.00 20.00           H  
ATOM      6  H   ETH A   1      -0.340   1.020   0.000  1.00 20.00           H  
ATOM      7  H   ETH A   1       1.870  -0.510  -0.880  1.00 20.00           H  
ATOM      8  H   ETH A   1       1.870  -0.510   0.880  1.00 20.00           H  
ATOM      9  H   ETH A   1       2.980   1.330   0.000  1.00 20.00           H  
CONECT    1    2    4    5    6
CONECT    2    1    3    7    8
CONECT    3    2    9
END`,
                'C1=CC=CC=C1': `HEADER    BENZENE                         
ATOM      1  C   BEN A   1       1.400   0.000   0.000  1.00 20.00           C  
ATOM      2  C   BEN A   1       0.700   1.212   0.000  1.00 20.00           C  
ATOM      3  C   BEN A   1      -0.700   1.212   0.000  1.00 20.00           C  
ATOM      4  C   BEN A   1      -1.400   0.000   0.000  1.00 20.00           C  
ATOM      5  C   BEN A   1      -0.700  -1.212   0.000  1.00 20.00           C  
ATOM      6  C   BEN A   1       0.700  -1.212   0.000  1.00 20.00           C  
ATOM      7  H   BEN A   1       2.488   0.000   0.000  1.00 20.00           H  
ATOM      8  H   BEN A   1       1.244   2.155   0.000  1.00 20.00           H  
ATOM      9  H   BEN A   1      -1.244   2.155   0.000  1.00 20.00           H  
ATOM     10  H   BEN A   1      -2.488   0.000   0.000  1.00 20.00           H  
ATOM     11  H   BEN A   1      -1.244  -2.155   0.000  1.00 20.00           H  
ATOM     12  H   BEN A   1       1.244  -2.155   0.000  1.00 20.00           H  
CONECT    1    2    6    7
CONECT    2    1    3    8
CONECT    3    2    4    9
CONECT    4    3    5   10
CONECT    5    4    6   11
CONECT    6    1    5   12
END`,
                'CC(=O)OC1=CC=CC=C1C(=O)O': `HEADER    ASPIRIN                         
ATOM      1  C   ASP A   1       0.000   0.000   0.000  1.00 20.00           C  
ATOM      2  C   ASP A   1       1.500   0.000   0.000  1.00 20.00           C  
ATOM      3  O   ASP A   1       2.100   1.200   0.000  1.00 20.00           O  
ATOM      4  O   ASP A   1       2.100  -1.200   0.000  1.00 20.00           O  
ATOM      5  C   ASP A   1       3.500  -1.200   0.000  1.00 20.00           C  
ATOM      6  C   ASP A   1       4.200   0.000   0.000  1.00 20.00           C  
ATOM      7  C   ASP A   1       5.600   0.000   0.000  1.00 20.00           C  
ATOM      8  C   ASP A   1       6.300  -1.200   0.000  1.00 20.00           C  
ATOM      9  C   ASP A   1       5.600  -2.400   0.000  1.00 20.00           C  
ATOM     10  C   ASP A   1       4.200  -2.400   0.000  1.00 20.00           C  
CONECT    1    2
CONECT    2    1    3    4
CONECT    4    2    5
CONECT    5    4    6   10
CONECT    6    5    7
CONECT    7    6    8
CONECT    8    7    9
CONECT    9    8   10
CONECT   10    5    9
END`,
                'C1CCCCC1': `HEADER    CYCLOHEXANE                     
ATOM      1  C   CYC A   1       1.200   0.693   0.000  1.00 20.00           C  
ATOM      2  C   CYC A   1       1.200  -0.693   0.000  1.00 20.00           C  
ATOM      3  C   CYC A   1       0.000  -1.386   0.000  1.00 20.00           C  
ATOM      4  C   CYC A   1      -1.200  -0.693   0.000  1.00 20.00           C  
ATOM      5  C   CYC A   1      -1.200   0.693   0.000  1.00 20.00           C  
ATOM      6  C   CYC A   1       0.000   1.386   0.000  1.00 20.00           C  
CONECT    1    2    6
CONECT    2    1    3
CONECT    3    2    4
CONECT    4    3    5
CONECT    5    4    6
CONECT    6    1    5
END`,
                'CN1C=NC2=C1C(=O)N(C(=O)N2C)C': `HEADER    CAFFEINE                        
ATOM      1  C   CAF A   1       0.000   0.000   0.000  1.00 20.00           C  
ATOM      2  N   CAF A   1       1.400   0.000   0.000  1.00 20.00           N  
ATOM      3  C   CAF A   1       2.100   1.200   0.000  1.00 20.00           C  
ATOM      4  N   CAF A   1       3.500   1.200   0.000  1.00 20.00           N  
ATOM      5  C   CAF A   1       4.200   0.000   0.000  1.00 20.00           C  
ATOM      6  C   CAF A   1       3.500  -1.200   0.000  1.00 20.00           C  
ATOM      7  C   CAF A   1       2.100  -1.200   0.000  1.00 20.00           C  
ATOM      8  O   CAF A   1       4.000  -2.400   0.000  1.00 20.00           O  
ATOM      9  N   CAF A   1       1.400  -2.400   0.000  1.00 20.00           N  
ATOM     10  C   CAF A   1       0.000  -2.400   0.000  1.00 20.00           C  
ATOM     11  O   CAF A   1      -0.700  -3.600   0.000  1.00 20.00           O  
ATOM     12  N   CAF A   1       5.600   0.000   0.000  1.00 20.00           N  
ATOM     13  C   CAF A   1       6.300   1.200   0.000  1.00 20.00           C  
CONECT    1    2
CONECT    2    1    3    7
CONECT    3    2    4
CONECT    4    3    5
CONECT    5    4    6   12
CONECT    6    5    7    8
CONECT    7    2    6    9
CONECT    9    7   10
CONECT   10    9   11
CONECT   12    5   13
END`
            };

            // Return structure if available, otherwise generate a simple default
            if (structures[smiles]) {
                return structures[smiles];
            }

            // Generate a simple default structure for unknown molecules
            return `HEADER    MOLECULE                        
ATOM      1  C   MOL A   1       0.000   0.000   0.000  1.00 20.00           C  
ATOM      2  C   MOL A   1       1.530   0.000   0.000  1.00 20.00           C  
ATOM      3  N   MOL A   1       2.265   1.330   0.000  1.00 20.00           N  
ATOM      4  H   MOL A   1      -0.340  -0.510  -0.880  1.00 20.00           H  
ATOM      5  H   MOL A   1      -0.340  -0.510   0.880  1.00 20.00           H  
ATOM      6  H   MOL A   1      -0.340   1.020   0.000  1.00 20.00           H  
ATOM      7  H   MOL A   1       1.870  -0.510  -0.880  1.00 20.00           H  
ATOM      8  H   MOL A   1       1.870  -0.510   0.880  1.00 20.00           H  
ATOM      9  H   MOL A   1       3.205   1.330   0.000  1.00 20.00           H  
ATOM     10  H   MOL A   1       1.925   2.270   0.000  1.00 20.00           H  
CONECT    1    2    4    5    6
CONECT    2    1    3    7    8
CONECT    3    2    9   10
END`;
        }

        function applyStyle(style) {
            if (!mol3dViewer) {
                console.warn('3Dmol viewer not available for style application');
                return;
            }

            try {
                updateDebug('Applying 3D style: ' + style);
                
                // Clear existing styles
                mol3dViewer.setStyle({}, {});

                // Apply new style based on selection
                switch (style) {
                    case 'stick':
                        mol3dViewer.setStyle({}, { 
                            stick: { 
                                radius: 0.2, 
                                colorscheme: 'default',
                                opacity: 0.9
                            } 
                        });
                        break;
                    case 'sphere':
                        mol3dViewer.setStyle({}, { 
                            sphere: { 
                                radius: 0.6, 
                                colorscheme: 'default',
                                opacity: 0.8
                            } 
                        });
                        break;
                    case 'line':
                        mol3dViewer.setStyle({}, { 
                            line: { 
                                linewidth: 3,
                                colorscheme: 'default'
                            } 
                        });
                        break;
                    case 'cartoon':
                        mol3dViewer.setStyle({}, { 
                            cartoon: { 
                                color: 'spectrum',
                                opacity: 0.9
                            } 
                        });
                        break;
                    default:
                        // Default to stick
                        mol3dViewer.setStyle({}, { 
                            stick: { 
                                radius: 0.2, 
                                colorscheme: 'default'
                            } 
                        });
                }
                
                // Render the changes
                mol3dViewer.render();
                updateDebug('3D style applied successfully: ' + style);
                
            } catch (error) {
                console.error('Style application error:', error);
                updateDebug('Style application error: ' + error.message);
            }
        }

        async function updateProperties(smiles, metadata = {}) {
            try {
                updateDebug('Calculating molecular properties...');
                
                const mol = RDKit.get_mol(smiles);
                if (!mol) {
                    throw new Error('Could not create molecule from SMILES');
                }

                // Try different approaches to get molecular properties
                let mw, logp, tpsa, hbd, hba, canonical;
                
                // First try: Use descriptors if available
                try {
                    if (typeof mol.get_descriptors === 'function') {
                        const descriptorsJson = mol.get_descriptors();
                        updateDebug('Raw descriptors: ' + descriptorsJson);
                        
                        if (descriptorsJson) {
                            const desc = JSON.parse(descriptorsJson);
                            console.log('Parsed descriptors:', desc);
                            
                            // Try common descriptor names
                            mw = desc.MW || desc.mw || desc.MolWt || desc.molecular_weight || null;
                            logp = desc.LogP || desc.logp || desc.MolLogP || desc.logP || null;
                            tpsa = desc.TPSA || desc.tpsa || null;
                            hbd = desc.NumHBD || desc.HBD || desc.hbd || desc.num_hbd || null;
                            hba = desc.NumHBA || desc.HBA || desc.hba || desc.num_hba || null;
                        }
                    }
                } catch (e) {
                    console.warn('Descriptors approach failed:', e);
                }
                
                // Second try: Use RDKit level functions if molecule methods don't work
                if (mw === null || mw === undefined) {
                    try {
                        // Try RDKit level functions
                        if (typeof RDKit.get_mol_mw === 'function') {
                            mw = RDKit.get_mol_mw(mol);
                        }
                    } catch (e) {
                        console.warn('RDKit level MW failed:', e);
                    }
                }
                
                // Canonical SMILES
                try {
                    if (typeof mol.get_smiles === 'function') {
                        canonical = mol.get_smiles();
                    } else {
                        canonical = smiles;
                        console.warn('Using input SMILES as canonical');
                    }
                } catch (e) {
                    console.warn('Canonical SMILES failed:', e);
                    canonical = smiles;
                }

                // Clean up molecule
                mol.delete();

                // Update displays with fallback values
                document.getElementById('mw-value').textContent = mw !== null && mw !== undefined ? 
                    (typeof mw === 'number' ? mw.toFixed(2) : mw) : 'N/A';
                document.getElementById('logp-value').textContent = logp !== null && logp !== undefined ? 
                    (typeof logp === 'number' ? logp.toFixed(2) : logp) : 'N/A';
                document.getElementById('tpsa-value').textContent = tpsa !== null && tpsa !== undefined ? 
                    (typeof tpsa === 'number' ? tpsa.toFixed(2) : tpsa) : 'N/A';
                document.getElementById('hbd-value').textContent = hbd !== null && hbd !== undefined ? hbd : 'N/A';
                document.getElementById('hba-value').textContent = hba !== null && hba !== undefined ? hba : 'N/A';
                document.getElementById('canonical-smiles').textContent = canonical || smiles;

                // Add PubChem metadata if available
                if (metadata.pubchemCID) {
                    document.getElementById('pubchem-cid').textContent = metadata.pubchemCID;
                    document.getElementById('pubchem-cid-property').style.display = 'block';
                } else {
                    document.getElementById('pubchem-cid-property').style.display = 'none';
                }
                
                if (metadata.searchTerm) {
                    document.getElementById('compound-name').textContent = metadata.searchTerm;
                    document.getElementById('compound-name-property').style.display = 'block';
                } else {
                    document.getElementById('compound-name-property').style.display = 'none';
                }

                mol.delete();
                updateDebug('Properties calculated successfully');
                
            } catch (error) {
                console.error('Properties calculation error:', error);
                updateDebug('Properties calculation error: ' + error.message);
                
                // Set fallback values
                document.getElementById('mw-value').textContent = 'Error';
                document.getElementById('logp-value').textContent = 'Error';
                document.getElementById('tpsa-value').textContent = 'Error';
                document.getElementById('hbd-value').textContent = 'Error';
                document.getElementById('hba-value').textContent = 'Error';
                document.getElementById('canonical-smiles').textContent = smiles;
            }
        }

        function loadPubChemExample() {
            const examples = [
                'caffeine',
                'aspirin', 
                'ibuprofen',
                'acetaminophen',
                'penicillin',
                'morphine',
                'nicotine',
                'ethanol',
                'glucose',
                'testosterone',
                'dopamine',
                'serotonin'
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('pubchem-search').value = randomExample;
            searchPubChem();
        }

        function loadExample() {
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('molecule-input').value = randomExample;
            updateDebug('Loading example: ' + randomExample);
            loadMolecule();
        }

        function update3DStyle() {
            const style = document.getElementById('style-select').value;
            applyStyle(style);
        }

        async function exportSVG() {
            try {
                const smiles = document.getElementById('molecule-input').value.trim();
                if (!smiles || !RDKit) {
                    updateStatus('Cannot export: no molecule or RDKit unavailable', 'error');
                    return;
                }

                const mol = RDKit.get_mol(smiles);
                if (!mol) {
                    updateStatus('Cannot export: invalid molecule', 'error');
                    return;
                }

                let svg;
                try {
                    if (mol.get_svg_with_highlights) {
                        svg = mol.get_svg_with_highlights(JSON.stringify({
                            width: 600,
                            height: 600,
                            bondLineWidth: 2
                        }));
                    } else if (mol.get_svg) {
                        svg = mol.get_svg(600, 600);
                    } else {
                        throw new Error('No SVG export method available');
                    }
                } catch (svgError) {
                    mol.delete();
                    updateStatus('SVG export not supported in this RDKit.js version', 'warning');
                    return;
                }
                
                mol.delete();
                
                const blob = new Blob([svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'molecule.svg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                updateStatus('SVG exported successfully!', 'success');
                updateDebug('SVG export completed');

            } catch (error) {
                updateStatus('SVG export failed: ' + error.message, 'error');
                updateDebug('SVG export error: ' + error.message);
            }
        }

        async function exportPNG() {
            try {
                if (!mol3dViewer) {
                    updateStatus('Cannot export: 3D viewer unavailable', 'error');
                    return;
                }

                const png = mol3dViewer.pngURI();
                const a = document.createElement('a');
                a.href = png;
                a.download = 'molecule_3d.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                updateStatus('PNG exported successfully!', 'success');
                updateDebug('PNG export completed');

            } catch (error) {
                updateStatus('PNG export failed: ' + error.message, 'error');
                updateDebug('PNG export error: ' + error.message);
            }
        }

        // Start initialization when page loads
        window.addEventListener('load', () => {
            updateDebug('Page loaded, starting initialization...');
            setTimeout(initializeVisualization, 100);
        });
    </script>
</body>
</html>
