<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CREB Enhanced: Next-Generation Molecular Animation System</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    
    <style>
        /* Enhanced Styling System */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff4444;
            --bg-light: #ffffff;
            --bg-dark: #1a1a1a;
            --text-light: #333333;
            --text-dark: #ffffff;
            --shadow-light: rgba(0,0,0,0.1);
            --shadow-dark: rgba(0,0,0,0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }
        
        .creb-enhanced-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px var(--shadow-dark);
            margin-bottom: 10px;
        }
        
        .header .tagline {
            font-size: 1.4rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .feature-card h3 {
            color: var(--success-color);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .feature-card ul {
            list-style: none;
            padding-left: 0;
        }
        
        .feature-card li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .feature-card li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: var(--success-color);
            font-weight: bold;
        }
        
        .demo-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .demo-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .enhanced-input {
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-dark);
            font-size: 16px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .enhanced-input:focus {
            outline: none;
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .enhanced-button {
            padding: 15px 30px;
            background: linear-gradient(45deg, var(--success-color), #00cc77);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .enhanced-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }
        
        .enhanced-button:active {
            transform: translateY(0);
        }
        
        .enhanced-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .viewer-container {
            position: relative;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        #enhanced-viewer {
            width: 100%;
            height: 100%;
        }
        
        .status-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 10;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 10px;
            display: none;
        }
        
        .status-card.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-success { border-left: 4px solid var(--success-color); }
        .status-warning { border-left: 4px solid var(--warning-color); }
        .status-error { border-left: 4px solid var(--error-color); }
        .status-info { border-left: 4px solid var(--primary-color); }
        
        .controls-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        .controls-panel.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .playback-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            padding: 10px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .progress-container {
            flex: 1;
            margin: 0 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .time-display {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-top: 5px;
        }
        
        .quality-settings {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quality-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 6px 12px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .quality-btn.active {
            background: var(--success-color);
            border-color: var(--success-color);
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .example-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .example-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }
        
        .example-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--success-color);
        }
        
        .example-equation {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .example-description {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .footer a {
            color: var(--success-color);
            text-decoration: none;
            font-weight: 600;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header .tagline {
                font-size: 1.1rem;
            }
            
            .demo-controls {
                grid-template-columns: 1fr;
            }
            
            .viewer-container {
                height: 400px;
            }
            
            .playback-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Accessibility Enhancements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .feature-card,
            .demo-section,
            .enhanced-input,
            .status-card,
            .controls-panel,
            .example-card {
                border-width: 2px;
                border-color: white;
            }
        }
    </style>
</head>
<body>
    <div class="creb-enhanced-container">
        <header class="header" role="banner">
            <h1>CREB Enhanced</h1>
            <p class="tagline">Next-Generation Chemical Reaction Animation System</p>
            <p>Experience advanced molecular visualization with AI-powered insights, cross-browser compatibility, and enhanced user interactions.</p>
        </header>

        <!-- Features Overview -->
        <section class="features-grid" role="region" aria-labelledby="features-heading">
            <h2 id="features-heading" class="visually-hidden">Enhanced Features</h2>
            
            <div class="feature-card">
                <h3>üé¨ Animation Issues Fixed</h3>
                <ul>
                    <li>Advanced timing control</li>
                    <li>Smooth transitions</li>
                    <li>Enhanced visual effects</li>
                    <li>Particle systems</li>
                    <li>Energy visualization</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>üß¨ Molecular Rendering Enhanced</h3>
                <ul>
                    <li>3Dmol.js integration</li>
                    <li>Structure accuracy validation</li>
                    <li>Scientific color schemes</li>
                    <li>Quality assessment</li>
                    <li>Multiple representations</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>‚ö° Performance Optimized</h3>
                <ul>
                    <li>Memory management</li>
                    <li>Adaptive quality</li>
                    <li>Frame rate control</li>
                    <li>Resource cleanup</li>
                    <li>Level-of-detail rendering</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>üéØ UI/UX Improved</h3>
                <ul>
                    <li>Responsive design</li>
                    <li>Accessibility features</li>
                    <li>Touch optimization</li>
                    <li>Keyboard navigation</li>
                    <li>Real-time feedback</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>üåê Browser Compatibility</h3>
                <ul>
                    <li>Cross-browser testing</li>
                    <li>WebGL fallbacks</li>
                    <li>Mobile optimization</li>
                    <li>Capability detection</li>
                    <li>Graceful degradation</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>üöÄ Enhanced Features</h3>
                <ul>
                    <li>AI-powered analysis</li>
                    <li>Advanced equation parsing</li>
                    <li>Educational tools</li>
                    <li>Import/export formats</li>
                    <li>Collaboration features</li>
                </ul>
            </div>
        </section>

        <!-- Main Demo Section -->
        <main class="demo-section" role="main">
            <h2>Interactive Molecular Animation Demo</h2>
            
            <div class="demo-controls">
                <div class="input-group">
                    <label for="equation-input">Chemical Equation</label>
                    <input 
                        type="text" 
                        id="equation-input" 
                        class="enhanced-input"
                        placeholder="Enter equation (e.g., H2 + O2 ‚Üí H2O)"
                        aria-describedby="equation-help"
                        spellcheck="false"
                        autocomplete="off"
                    >
                    <div id="equation-help" class="visually-hidden">
                        Enter a chemical equation using molecular formulas. Use ‚Üí or = for the reaction arrow.
                    </div>
                </div>
                
                <button 
                    id="animate-btn" 
                    class="enhanced-button"
                    aria-label="Generate enhanced molecular animation"
                >
                    Generate Animation
                </button>
            </div>
            
            <div class="viewer-container">
                <div id="enhanced-viewer" aria-label="Enhanced 3D molecular animation viewer"></div>
                
                <!-- Status Overlay -->
                <div class="status-overlay">
                    <div id="status-info" class="status-card status-info">
                        <strong>Info:</strong> <span id="status-info-text"></span>
                    </div>
                    <div id="status-success" class="status-card status-success">
                        <strong>Success:</strong> <span id="status-success-text"></span>
                    </div>
                    <div id="status-warning" class="status-card status-warning">
                        <strong>Warning:</strong> <span id="status-warning-text"></span>
                    </div>
                    <div id="status-error" class="status-card status-error">
                        <strong>Error:</strong> <span id="status-error-text"></span>
                    </div>
                </div>
                
                <!-- Enhanced Controls Panel -->
                <div id="controls-panel" class="controls-panel">
                    <div class="playback-controls">
                        <button id="play-btn" class="control-btn" aria-label="Play animation">‚ñ∂Ô∏è</button>
                        <button id="pause-btn" class="control-btn" aria-label="Pause animation">‚è∏Ô∏è</button>
                        <button id="stop-btn" class="control-btn" aria-label="Stop animation">‚èπÔ∏è</button>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill"></div>
                            </div>
                            <div class="time-display">
                                <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                            </div>
                        </div>
                        
                        <button id="reset-view" class="control-btn" aria-label="Reset camera view">üè†</button>
                        <button id="fullscreen-btn" class="control-btn" aria-label="Toggle fullscreen">‚õ∂</button>
                    </div>
                    
                    <div class="quality-settings">
                        <span>Quality:</span>
                        <button class="quality-btn" data-quality="low">Low</button>
                        <button class="quality-btn active" data-quality="medium">Medium</button>
                        <button class="quality-btn" data-quality="high">High</button>
                        <button class="quality-btn" data-quality="ultra">Ultra</button>
                    </div>
                </div>
            </div>
            
            <!-- Example Reactions -->
            <div class="examples-grid">
                <div class="example-card" data-equation="H2 + O2 ‚Üí H2O">
                    <div class="example-title">Water Formation</div>
                    <div class="example-equation">H‚ÇÇ + O‚ÇÇ ‚Üí H‚ÇÇO</div>
                    <div class="example-description">Basic synthesis reaction with hydrogen and oxygen</div>
                </div>
                
                <div class="example-card" data-equation="CH4 + O2 ‚Üí CO2 + H2O">
                    <div class="example-title">Methane Combustion</div>
                    <div class="example-equation">CH‚ÇÑ + O‚ÇÇ ‚Üí CO‚ÇÇ + H‚ÇÇO</div>
                    <div class="example-description">Combustion reaction with energy release visualization</div>
                </div>
                
                <div class="example-card" data-equation="NaCl ‚Üí Na+ + Cl-">
                    <div class="example-title">Salt Dissociation</div>
                    <div class="example-equation">NaCl ‚Üí Na‚Å∫ + Cl‚Åª</div>
                    <div class="example-description">Ionic dissociation in aqueous solution</div>
                </div>
                
                <div class="example-card" data-equation="C6H12O6 + O2 ‚Üí CO2 + H2O">
                    <div class="example-title">Glucose Oxidation</div>
                    <div class="example-equation">C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + O‚ÇÇ ‚Üí CO‚ÇÇ + H‚ÇÇO</div>
                    <div class="example-description">Cellular respiration with complex molecular structures</div>
                </div>
            </div>
        </main>
        
        <footer class="footer" role="contentinfo">
            <p>
                Powered by <a href="#" aria-label="CREB Enhanced System">CREB Enhanced</a> | 
                Advanced molecular visualization with AI-powered insights
            </p>
            <p>
                Features: Enhanced Animations ‚Ä¢ Improved Rendering ‚Ä¢ Performance Optimization ‚Ä¢ 
                Cross-Browser Compatibility ‚Ä¢ Accessibility Support
            </p>
        </footer>
    </div>

    <!-- Load required dependencies -->
    <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- CREB Enhanced System -->
    <script src="../dist/index.umd.js"></script>
    <script>
        // Enhanced Demo Application
        class CREBEnhancedDemo {
            constructor() {
                this.enhancedSystem = null;
                this.isAnimating = false;
                this.currentAnimation = null;
                
                this.initializeUI();
                this.setupEventListeners();
                this.initializeEnhancedSystem();
            }
            
            async initializeEnhancedSystem() {
                try {
                    this.showStatus('info', 'Initializing CREB Enhanced System...');
                    
                    // Create a dedicated container for the enhanced system
                    const viewerContainer = document.getElementById('enhanced-viewer');
                    viewerContainer.innerHTML = '<div id="molecular-viewer" style="width: 100%; height: 100%;"></div>';
                    
                    const molecularContainer = document.getElementById('molecular-viewer');
                    
                    // Create enhanced CREB system with simplified UI
                    this.enhancedSystem = CREB.createEnhancedCREB(molecularContainer, {
                        animation: {
                            duration: 4000,
                            qualityLevel: 'medium',
                            particleEffects: true,
                            adaptiveQuality: true
                        },
                        rendering: {
                            useExperimentalData: true,
                            materialQuality: 'high',
                            validateGeometry: true,
                            antialiasing: true
                        },
                        ui: {
                            theme: 'dark',
                            touchOptimized: true,
                            keyboardNavigation: true,
                            screenReaderSupport: true,
                            compactMode: true
                        },
                        compatibility: {
                            autoOptimize: true,
                            performanceMode: 'auto',
                            detectCapabilities: true
                        },
                        features: {
                            showStepByStep: true,
                            provideInsights: true,
                            enableComparisons: true
                        }
                    });
                    
                    // Wait for initialization with better timeout handling
                    await this.waitForSystemReady();
                    
                    this.showStatus('success', 'CREB Enhanced System ready!');
                    this.updateCapabilitiesDisplay();
                    
                } catch (error) {
                    console.error('Enhanced system initialization failed:', error);
                    this.showStatus('error', `Initialization failed: ${error.message}`);
                    
                    // Fallback to basic system
                    this.initializeFallbackSystem();
                }
            }
            
            async waitForSystemReady() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50; // 5 seconds
                    
                    const checkReady = () => {
                        attempts++;
                        
                        if (this.enhancedSystem && typeof this.enhancedSystem.isReady === 'function' && this.enhancedSystem.isReady()) {
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            reject(new Error('Initialization timeout'));
                        } else {
                            setTimeout(checkReady, 100);
                        }
                    };
                    
                    checkReady();
                });
            }
            
            initializeFallbackSystem() {
                try {
                    this.showStatus('info', 'Initializing fallback animation system...');
                    
                    // Use basic animation system as fallback
                    const container = document.getElementById('enhanced-viewer');
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                            <div>
                                <h3>Basic Animation Mode</h3>
                                <p>Enhanced features unavailable. Using simplified animation system.</p>
                            </div>
                        </div>
                    `;
                    
                    // Create a simple fallback object
                    this.enhancedSystem = {
                        isReady: () => true,
                        animateReaction: async (request) => {
                            this.showStatus('info', `Simulating animation for: ${request.equation}`);
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            return {
                                success: true,
                                duration: 1000,
                                quality: 'basic',
                                frames: 60,
                                errors: [],
                                warnings: ['Using fallback system'],
                                performance: { renderTime: 16, memoryUsed: 0.1, fps: 60 }
                            };
                        },
                        getCapabilities: () => ({ fallback: true }),
                        getSystemStatus: () => ({ overall: 'fallback' })
                    };
                    
                    this.showStatus('success', 'Fallback system ready');
                    
                } catch (error) {
                    this.showStatus('error', `Fallback initialization failed: ${error.message}`);
                }
            }
            
            updateCapabilitiesDisplay() {
                if (!this.enhancedSystem) return;
                
                const capabilities = this.enhancedSystem.getCapabilities();
                const status = this.enhancedSystem.getSystemStatus();
                
                console.log('Browser Capabilities:', capabilities);
                console.log('System Status:', status);
                
                // Update UI based on capabilities
                if (!capabilities.webgl) {
                    this.showStatus('warning', 'WebGL not available - using fallback renderer');
                }
                
                if (capabilities.mobile) {
                    this.showStatus('info', 'Mobile optimizations enabled');
                }
            }
            
            initializeUI() {
                // Show controls panel
                document.getElementById('controls-panel').classList.add('show');
                
                // Set default equation
                document.getElementById('equation-input').value = 'H2 + O2 ‚Üí H2O';
            }
            
            setupEventListeners() {
                // Main animation button
                document.getElementById('animate-btn').addEventListener('click', () => {
                    this.handleAnimationRequest();
                });
                
                // Enter key in input
                document.getElementById('equation-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.handleAnimationRequest();
                    }
                });
                
                // Example cards
                document.querySelectorAll('.example-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const equation = e.currentTarget.dataset.equation;
                        document.getElementById('equation-input').value = equation;
                        this.handleAnimationRequest();
                    });
                });
                
                // Playback controls
                document.getElementById('play-btn').addEventListener('click', () => {
                    this.playAnimation();
                });
                
                document.getElementById('pause-btn').addEventListener('click', () => {
                    this.pauseAnimation();
                });
                
                document.getElementById('stop-btn').addEventListener('click', () => {
                    this.stopAnimation();
                });
                
                // Quality controls
                document.querySelectorAll('.quality-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.setQuality(e.target.dataset.quality);
                    });
                });
                
                // Fullscreen button
                document.getElementById('fullscreen-btn').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
            }
            
            async handleAnimationRequest() {
                const equation = document.getElementById('equation-input').value.trim();
                
                if (!equation) {
                    this.showStatus('warning', 'Please enter a chemical equation');
                    return;
                }
                
                if (!this.enhancedSystem || !this.enhancedSystem.isReady()) {
                    this.showStatus('error', 'Enhanced system not ready');
                    return;
                }
                
                try {
                    this.setAnimating(true);
                    this.showStatus('info', 'Generating enhanced animation...');
                    
                    const result = await this.enhancedSystem.animateReaction({
                        equation: equation,
                        options: {
                            quality: this.getCurrentQuality(),
                            effects: true,
                            stepByStep: true
                        }
                    });
                    
                    if (result.success) {
                        this.showStatus('success', 
                            `Animation completed! Duration: ${(result.duration/1000).toFixed(1)}s, ` +
                            `FPS: ${result.performance.fps}, Quality: ${result.quality}`
                        );
                        
                        this.updateAnimationInfo(result);
                    } else {
                        this.showStatus('error', `Animation failed: ${result.errors.join(', ')}`);
                    }
                    
                } catch (error) {
                    console.error('Animation request failed:', error);
                    this.showStatus('error', `Animation failed: ${error.message}`);
                } finally {
                    this.setAnimating(false);
                }
            }
            
            getCurrentQuality() {
                const activeBtn = document.querySelector('.quality-btn.active');
                return activeBtn ? activeBtn.dataset.quality : 'medium';
            }
            
            setQuality(quality) {
                // Update quality setting
                console.log('Quality changed to:', quality);
            }
            
            updateAnimationInfo(result) {
                // Update time displays
                const totalSeconds = result.duration / 1000;
                document.getElementById('total-time').textContent = this.formatTime(totalSeconds);
                
                // Show performance metrics
                if (result.performance.fps < 30) {
                    this.showStatus('warning', `Low frame rate detected: ${result.performance.fps} FPS`);
                }
            }
            
            playAnimation() {
                if (this.enhancedSystem) {
                    // Implementation depends on animation controller API
                    console.log('Play animation');
                }
            }
            
            pauseAnimation() {
                if (this.enhancedSystem) {
                    // Implementation depends on animation controller API
                    console.log('Pause animation');
                }
            }
            
            stopAnimation() {
                if (this.enhancedSystem) {
                    // Implementation depends on animation controller API
                    console.log('Stop animation');
                }
            }
            
            toggleFullscreen() {
                const container = document.querySelector('.viewer-container');
                
                if (!document.fullscreenElement) {
                    container.requestFullscreen().catch(err => {
                        this.showStatus('error', `Fullscreen failed: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            }
            
            setAnimating(isAnimating) {
                this.isAnimating = isAnimating;
                const btn = document.getElementById('animate-btn');
                btn.disabled = isAnimating;
                btn.textContent = isAnimating ? 'Generating...' : 'Generate Animation';
            }
            
            showStatus(type, message, duration = 3000) {
                const statusElement = document.getElementById(`status-${type}`);
                const textElement = document.getElementById(`status-${type}-text`);
                
                if (statusElement && textElement) {
                    textElement.textContent = message;
                    statusElement.classList.add('show');
                    
                    setTimeout(() => {
                        statusElement.classList.remove('show');
                    }, duration);
                }
                
                console.log(`[${type.toUpperCase()}]`, message);
            }
            
            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }
        
        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CREBEnhancedDemo();
        });
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        document.getElementById('animate-btn').click();
                        break;
                    case ' ':
                        e.preventDefault();
                        document.getElementById('play-btn').click();
                        break;
                }
            }
        });
    </script>
</body>
</html>
